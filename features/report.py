import os
import logging
import traceback
from datetime import datetime
from zoneinfo import ZoneInfo
# –í–∞–∂–Ω–æ: –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∞–º –∫–ª–∞—Å—Å OpenAI
from openai import OpenAI

TZ = ZoneInfo("Europe/Warsaw")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
PROMPT_GPT = os.getenv("PROMPT_GPT")

def generate_daily_report_with_gpt(sheet):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets –≤ GPT –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º–∏ –∏ –æ—Ü–µ–Ω–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
    """
    try:
        # --- –°–æ–∑–¥–∞—ë–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç ---
        # –≠—Ç–æ –∫–ª—é—á –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é.
        # –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è "—Å–≤–µ–∂–∏–π" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
        client = OpenAI(api_key=OPENAI_API_KEY)
        
        records = sheet.get_all_records()
        if not records:
            return "üì≠ –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞, –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞."

        today_str = datetime.now(TZ).strftime("%Y-%m-%d")

        # --- –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π ---
        today_activities = "üìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:\n"
        has_today = False
        for r in records:
            date_val = str(r.get("Date Activity", "")).strip()
            activity = str(r.get("Activity", "")).strip()
            duration = str(r.get("Duration", "")).strip()
            if date_val == today_str:
                has_today = True
                today_activities += f"{activity} ‚Äî {duration}\n"

        if not has_today:
            today_activities += "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\n"

        # --- –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è GPT (–∞–Ω–∞–ª–∏–∑ –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã) ---
        table_text = "Date Activity\tActivity\tDuration\n"
        for r in records:
            date_val = str(r.get("Date Activity", "")).strip()
            activity = str(r.get("Activity", "")).strip()
            duration = str(r.get("Duration", "")).strip()
            table_text += f"{date_val}\t{activity}\t{duration}\n"

        prompt = f"{PROMPT_GPT}\n\n{table_text}"        
        print("üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ GPT...")  
        
        # --- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç 'client' ---
        try:
            response = client.chat.completions.create(
                model="gpt-5",
                messages=[
                    {
                        "role": "system",
                        "content": (
                            "–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∫–æ—É—á –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, "
                            "–∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞–∑–≤–∏–≤–∞—Ç—å –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –∏ –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ä–∞–±–æ—Ç–æ–π –∏ –∂–∏–∑–Ω—å—é. "
                            "–ü–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫: —Å —Ç–µ–ø–ª–æ–º, –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏ –ª—ë–≥–∫–æ–π –∏—Ä–æ–Ω–∏–µ–π, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –≥–ª—É–±–æ–∫–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ. "
                            "–ö–∞–∂–¥—ã–π –æ—Ç—á—ë—Ç –¥–æ–ª–∂–µ–Ω –∑–≤—É—á–∞—Ç—å —Ç–∞–∫, –±—É–¥—Ç–æ —Ç—ã —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å —Å –¥—Ä—É–≥–æ–º –≤–µ—á–µ—Ä–æ–º ‚Äî –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –ø–æ –¥–µ–ª—É. "
                            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å –º–∏–Ω—É—Ç—ã, –∞ —É–≤–∏–¥–µ—Ç—å –∑–∞ —Ü–∏—Ñ—Ä–∞–º–∏ —Å–º—ã—Å–ª –¥–Ω—è, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –ø—Ä–∏–≤—ã—á–∫–∏. "
                            "–ü–∏—à–∏ –∂–∏–≤–æ, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Å —ç–º–æ–¥–∑–∏ –∏ –ª—ë–≥–∫–∏–º–∏ –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏. "
                            "–ò–∑–±–µ–≥–∞–π —Å—É—Ö–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –∏ —à–∞–±–ª–æ–Ω–æ–≤. "
                            "–§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–≥–æ —á–µ—Ç—ã—Ä—ë—Ö –±–ª–æ–∫–æ–≤:"
                            "\n\n1Ô∏è‚É£ **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏** ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏–ª–∏ —Å–ø–∏—Å–∫–µ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ (—Ä–∞–±–æ—Ç–∞, –±—ã—Ç, –æ—Ç–¥—ã—Ö, –∑–¥–æ—Ä–æ–≤—å–µ, –ª–∏—á–Ω–æ–µ –∏ —Ç.–¥.). "
                            "–£–∫–∞–∂–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –º–∏–Ω—É—Ç—ã –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç 780 –º–∏–Ω—É—Ç (9:00‚Äì22:00). "
                            "–ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ ‚Äî —Å—á–∏—Ç–∞–π –∏—Ö –∫–∞–∫ '—Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è'. "
                            "–ò—Å–ø–æ–ª—å–∑—É–π –ª—é–±—ã–µ —É–º–µ—Å—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏."
                            "–£–±–µ–¥–∏—Å—å, –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç–æ–≤ –∏ —á—Ç–æ —Å—É–º–º–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –ø–æ –¥–Ω—é = 100%."
                            "\n\n2Ô∏è‚É£ **–û–±–∑–æ—Ä** ‚Äî —Å–¥–µ–ª–∞–π –∂–∏–≤–æ–π –∞–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–∞ –¥–Ω—è. "
                            "–û–ø–∏—à–∏, —á—Ç–æ –∑–∞–Ω—è–ª–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ, –≥–¥–µ –ø–µ—Ä–µ–∫–æ—Å, –≥–¥–µ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–µ. "
                            "–ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è, –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è. "
                            "–ù–µ –±–æ–π—Å—è –¥–æ–±–∞–≤–ª—è—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω—é–∞–Ω—Å—ã ‚Äî —É—Å—Ç–∞–ª–æ—Å—Ç—å, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è, —Ä–∏—Ç–º –¥–Ω—è."
                            "\n\n3Ô∏è‚É£ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å** ‚Äî –Ω–∞–ø–∏—à–∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏: —á—Ç–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç, —á—Ç–æ —Å—Ç–æ–∏—Ç –æ—Ç–º–µ—Ç–∏—Ç—å, –≥–¥–µ —á—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å, –∏ –≥–¥–µ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ. "
                            "–î–æ–±–∞–≤—å –¥—Ä—É–∂–µ—Å–∫–∏–π —Ç–æ–Ω, –ø—Ä–∏–º–µ—Ä—ã –∏–ª–∏ –ª—ë–≥–∫–∏–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã. "
                            "–¶–µ–ª—å ‚Äî —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ—Ç–µ–ª –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ, –∞ –Ω–µ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª –≤–∏–Ω—É. "
                            "\n\n4Ô∏è‚É£ **–ò–Ω—Å–∞–π—Ç—ã –∏ —Å–æ–≤–µ—Ç—ã** ‚Äî –≤—ã–¥–µ–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏, –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –¥–µ–Ω—å —á—É—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∏ —Å–ø–æ–∫–æ–π–Ω–µ–µ. "
                            "–ö–∞–∂–¥—ã–π —Å–æ–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –æ–±—ä—è—Å–Ω—è—Ç—å *–∑–∞—á–µ–º* ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ '–¥–æ–±–∞–≤—å –æ—Ç–¥—ã—Ö', –∞ '–ø–æ—á–µ–º—É —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç'. "
                            "–ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ, –Ω–æ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏, –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ."
                            "\n\n–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å—É—Ö–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –≤—Ä–æ–¥–µ '—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å'. "
                            "–ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ ‚Äî –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª—å–Ω–æ –ø–æ–Ω–∏–º–∞–µ—Ç –∂–∏–∑–Ω—å –∏ —É—Å—Ç–∞–ª–æ—Å—Ç—å."
                        )
                    },
                    {
                        "role": "user",
                        "content": (
                            "–Ø –∏–¥—É –∫ —Ü–µ–ª–∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å–≤–æ—ë–º –±–∏–∑–Ω–µ—Å–µ, –Ω–æ –Ω–µ –≤ —É—â–µ—Ä–± –∫–∞—á–µ—Å—Ç–≤—É –∂–∏–∑–Ω–∏, –∏ –∫–æ–ª–µ—Å—É –±–∞–ª–∞–Ω—Å–∞"
                            "–ø–æ—ç—Ç–æ–º—É —Ä–µ–≥—É–ª—è—Ä–Ω–æ –≤—ã—Å—ã–ª–∞—é —Ç–µ–±–µ –æ—Ç—á—ë—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞."
                        )
                    },
                    {"role": "user", "content": prompt},
                ],
            )
        except Exception as inner_e:
            print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ GPT (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π try):")
            print(traceback.format_exc())
            raise inner_e
        print("‚úÖ –û–¢–í–ï–¢ –û–¢ GPT:")
        
        answer = response.choices[0].message.content.strip()
              
        # --- –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ---
        report_text = (
            f"{today_activities}\n"
            f"{answer}"
        )

        return report_text

    except Exception as e:
        # –î–æ–±–∞–≤–∏–º traceback –¥–ª—è –ª—É—á—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è
        import traceback
        logging.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GPT: {e}\n{traceback.format_exc()}")
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GPT: {e}"
